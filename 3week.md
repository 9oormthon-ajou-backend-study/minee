## 3장 영속성 관리

### 3.1 엔티티 매니저 팩토리와 엔티티 매니저

- 엔티티 매니저 팩토리는 엔티티 매니저를 만드는 공장. 만드는 비용이 상당히 크다.
    - 한 개만 만들어서 애플리케이션 전체에서 공유하도록 설계되어 있다.
- 반면 공장에서 엔티티 매니저를 만드는  것은 비용이 거의 안 든다.
- 엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 됨 → 다른 스레드 간의 공유 OK
    - 엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성 문제가 발생 → 절대 공유하면 안 된다.
- JPA 구현체들은 엔티티 매니저 팩토리를 생성할 때 커넥션 풀도 만든다.

### 3.2 영속성 컨텍스트 persistence context

- 엔티티를 영구 저장하는 환경
- em.persist(member);는 엔티티 매니저를 사용해서 member 엔티티를 영속성 컨텍스트에 저장하는 것
- 영속성 컨텍스트는 엔티티 매니저가 하나 만들어질 때 하나씩 같이 만들어진다. 여러 엔티티 매니저가 하나의 영속성 컨텍스트를 바라볼 수도 있다.

### 3.3 엔티티의 생명 주기

엔티티의 4가지 상태 

- 비영속 (new/transient)
    - 영속성 컨텍스트와 전혀 관계가 없는 상태
    - em.persist()로 영속 상태로 만들 수 있다.
    - 영속된 적 없으므로 id가 존재하지 않을 수도 있다.
- 영속 (managed)
    - 영속성 컨텍스트에 저장된 상태
- 준영속 (detached)
    - 영속성 컨텍스트에 저장되었다가 분리된 상태
    - id가 반드시 존재한다. (영속 상태였으므로)
    - em.detach()로 영속 상태의 엔티티를 준영속 상태로 만들 수 있다.
    - em.clos()로 엔티티 매니저를 닫거나 em.clear()로 엔티티 매니저를 초기화해도 관리하던 엔티티들이 준영속 상태가 된다.
- 삭제 (removed)
    - 삭제된 상태
    - em.remove()로 엔티티를 영속성 컨텍스트에서 삭제한 상태
    

### 3.4 영속성 컨텍스트의 특징

공사중...
